---
- name: Install podman
  yum:
    name: podman
    state: present

- name: check if aicli exists
  stat:
    path: /usr/local/bin/aicli
  register: aicli_path

- name: Install aicli if not present
  block:
    - name: Create temporary directory for aicli
      tempfile:
        state: directory
      register: dockerfile_directory

    - name: Install assisted service client
      shell: |
        curl https://raw.githubusercontent.com/openshift/assisted-service/master/Dockerfile.assisted-service > {{ dockerfile_directory.path }}/Dockerfile.assisted-service
        podman build -t ocpmetal/assisted-service -f {{ dockerfile_directory.path }}/Dockerfile.assisted-service .
        podman run -v $PWD:/here --rm ocpmetal/assisted-service:latest cp -r /clients/assisted-service-client-1.0.0.tar.gz /here
        tar zxvf assisted-service-client-1.0.0.tar.gz
        cd assisted-service-client-1.0.0
        python3 setup.py install

    - name: Install aicli
      shell: |
          git clone https://github.com/karmab/assisted-installer-cli {{ dockerfile_directory.path }}/assisted-installer-cli
          pushd {{ dockerfile_directory.path }}/assisted-installer-cli
          python3 setup.py install
          popd
  when: aicli_path.stat.exists == False

- name: Create temporary directory for script
  tempfile:
    state: directory
  register: script_directory

- name: Get the script to create small ISO
  get_url:
      url: https://raw.githubusercontent.com/redhat-ztp/ztp-iso-generator/main/rhcos-iso/generate_rhcos_iso.sh
      dest: "{{ script_directory.path }}/generate_rhcos_iso.sh"

- name: Create the small ISO and copy to desired path
  script:
    chdir: "{{ script_directory.path }}"
    cmd: "{{ script_directory.path }}/generate_rhcos_iso.sh {{ small_iso_path }}"

- name: Clone the assisted installer project
  git:
    repo: 'https://github.com/openshift/assisted-service'
    dest: /opt/assisted-service-ztp
    update: no

- name: Add env var to file if does not exist
  lineinfile:
    path: /opt/assisted-service-ztp/onprem-environment
    line: "{{ item }}"
  with_items:
    - "SUPPORT_L2=false"
    - "SERVICE_BASE_URL=http://192.168.112.199:8090"
    - "HW_VALIDATOR_MIN_DISK_SIZE_GIB=50"

- name: Clean the pod
  shell: "podman pod rm -f assisted-installer"

- name: Start the assisted installer service
  shell: "make deploy-onprem"
  args:
    chdir: "/opt/assisted-service-ztp"
